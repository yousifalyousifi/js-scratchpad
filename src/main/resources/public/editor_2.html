<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>JS Scratchpad</title>
        <link href="css/bootstrap.4.0.0.min.cyborg.css" rel="stylesheet">
        <link href="css/scratchpad.css" rel="stylesheet" media="screen">
    </head>
    <body>
      
        <nav class="navbar navbar-expand-sm navbar-dark bg-dark">
            <a class="navbar-brand" href="#">JS Scratchpad</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav mr-auto">
                    <li id="runButton" title="Ctrl+R" class="nav-item">
                        <a class="nav-link" href="#">Run</a>
                    </li>
                    <li id="clearButton" class="nav-item">
                        <a class="nav-link" href="#">Clear</a>
                    </li>
                    <li id="p5RefButton" class="nav-item">
                        <a class="nav-link" href="#">Reference</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="snippetsDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Snippets
                        </a>
                        <div class="dropdown-menu" aria-labelledby="snippetsDropdown">
                            <a id="loadButton" class="dropdown-item" href="#" data-toggle="modal" data-target="#myModal">Snippets</a>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="viewDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            View
                        </a>
                        <div class="dropdown-menu" aria-labelledby="viewDropdown">
                            <a id="font14px" class="dropdown-item" href="#">14px</a>
                            <a id="font18px" class="dropdown-item" href="#">18px</a>
                            <a id="font24px" class="dropdown-item" href="#">24px</a>
                            <div class="dropdown-divider"></div>
                            <div id="ratioButtons" class="btn-group btn-group-toggle" data-toggle="buttons">
                              <label class="btn btn-sm btn-secondary">
                                <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAUCAYAAADskT9PAAAAMUlEQVR42mM4fvz4/4HEDIPGAQx4ADFqSAWjDhh1wKgDRh0w6oBRB4w6YPA5YMS2iAA4TemfUvBlyAAAAABJRU5ErkJggg==" alt="20 80"/>
                                <input type="radio" name="options" id="option1" checked>
                              </label>
                              <label class="btn btn-sm btn-secondary active">
                                <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAUCAYAAADskT9PAAAAMElEQVR42mM4fvz4/4HEDIPGAQxkAKroHXXAqANGHTDqgFEHjDpg1AGDxgEjtkUEADu36Z/FDLVCAAAAAElFTkSuQmCC" alt="50 50"/>
                                <input type="radio" name="options" id="option2">
                              </label>
                              <label class="btn btn-sm btn-secondary">
                                <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAUCAYAAADskT9PAAAANklEQVR42mM4fvz4/4HEDIPGAQxUBMSYOeqAUQeMOmDUAaMOGHXAqANo7oBjx46R5oAR2yICADum6ZzjSufRAAAAAElFTkSuQmCC" alt="80 20"/>
                                <input type="radio" name="options" id="option3"> 
                              </label>
                            </div>
                            <div class="dropdown-divider"></div>
                            <a id="wordWrap" class="dropdown-item" href="#">Enable Word Wrap</a>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="settingsDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Settings
                        </a>
                        <div class="dropdown-menu" id="settingsCheckbox" aria-labelledby="settingsDropdown">
                          <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="autorunCheckbox">
                            <label class="form-check-label" for="autorunCheckbox">Autorun p5
                          </div>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="modeDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Mode
                        </a>
                        <div class="dropdown-menu" aria-labelledby="modeDropdown">
                            <a id="consoleMode" class="dropdown-item" href="#">Console</span></a>
                            <a id="drawMode" class="dropdown-item" href="#">Draw</a>
                        </div>
                    </li>

                    <li id="b0" class="nav-item">
                        <a class="nav-link" href="#">back step</a>
                    </li>
                    <li id="b1" class="nav-item">
                        <a class="nav-link" href="#">forward step</a>
                    </li>
                    <li id="b2" class="nav-item">
                        <a class="nav-link" href="#">stop stepping</a>
                    </li>
                    <li id="b4" class="nav-item">
                        <a class="nav-link" href="#">start auto step</a>
                    </li>
                    <li id="b5" class="nav-item">
                        <a class="nav-link" href="#">stop auto step</a>
                    </li>
                    <li id="b6" class="nav-item">
                        <a class="nav-link" href="#">restore code</a>
                    </li>
                    <li id="b7" class="nav-item">
                        <a class="nav-link" href="#">B7</a>
                    </li>

                    <li id="b20" class="nav-item">
                        <a class="nav-link" href="#">Run Step Mode</a>
                    </li>
                    <li id="b21" class="nav-item">
                        <a class="nav-link" href="#">Stop Step Mode</a>
                    </li>
                    <li id="b22" class="nav-item">
                        <a class="nav-link" href="#">Step Forward</a>
                    </li>
                    <li id="b23" class="nav-item">
                        <a class="nav-link" href="#">Step Backward</a>
                    </li>
                    <li id="b24" class="nav-item">
                        <a class="nav-link" href="#">Start Autostep</a>
                    </li>
                    <li id="b25" class="nav-item">
                        <a class="nav-link" href="#">Stop Autostep</a>
                    </li>
                    <li id="b26" class="nav-item">
                        <a class="nav-link" href="#">Toggle Step Code</a>
                    </li>
                </ul>
            </div>
        </nav>

<pre style="display: none;" id="defaultCode">
function foo(items) {
    var i;
    for (i = 0; i &lt; items.length; i++) {
        console.log("Ace Rocks " + items[i]);
    }
}


</pre>
        <div id="editorContainer">
            <pre id="editor"></pre>
        </div>
        <div id="displayContainer">
        </div>
        <script src="js/ace/ace.js" type="text/javascript" charset="utf-8"></script>
        <script src="js/ace/ext-language_tools.js"></script>
        <script src="js/jquery/jquery3.2.1.js"></script>
        <script src="js/jquery/jquery.ba-throttle-debounce.min.js"></script>
        <script src="js/bootstrap/bootstrap.4.0.0.min.js"></script>
        <script src="js/acorn/acorn.js"></script>
        <script src="js/acorn/acorn_loose.js"></script>
        <script src="js/acorn/walk.js"></script>
        <script src="js/acorn/walkall.js"></script>
        <script src="js/p5/p5.js"></script>
        <script src="js/p5/addons/p5.sound.js"></script>
        <script src="js/p5/addons/p5.dom.js"></script>
        <script src="js/p5/addons/p5.func.js"></script>
        <script src="js/RateLimit.js"></script>
        <script src="js/CodeRunner.js"></script>
        <script src="js/DrawRunner.js"></script>
        <script src="js/Scratchpad.js"></script>
        <script>



var editor = ace.edit("editor");
Range = ace.require('ace/range').Range


var storedCode = window.localStorage.getItem("code");
if (storedCode) {
    editor.setValue(storedCode);
} else {
    editor.setValue($("#defaultCode").text());
}

editor.setTheme("ace/theme/monokai");
editor.session.setMode("ace/mode/javascript");
editor.setOptions({
    enableBasicAutocompletion: true,
    enableLiveAutocompletion: false
});
function monokai() {console.log('monokai!');editor.setTheme("ace/theme/monokai");}
function debugmonokai() {console.log('debugmonokai!');editor.setTheme("ace/theme/debugmonokai");}

var storedCode = window.localStorage.getItem("code");
if (storedCode) {
    editor.setValue(storedCode);
} else {editor.setValue("");}
editor.gotoLine(editor.session.getLength() + 1);
editor.commands.addCommand({
    name: 'process',
    bindKey: {
        win: 'Ctrl-F',
        mac: 'Command-F'
    },
    exec: function(editor) {
        try {
            console.log("processing.")
            window.localStorage.setItem("code", editor.getValue());
            undecoratedCode = editor.getValue();
        } catch(e) {
            console.error(e);
        }
        return false;
    },
    readOnly: false // false if this command should not apply in readOnly mode
});

window.pp = function() {
    console.log.apply(null, arguments);
};

forfeitHighlightControl = false;
stepping = false;
returnID = 0;
globalFuncCallStack = [];
GLOBAL_INDEX = 0;
fakeFrameCount = 0;
fakeMouseX = 0;
fakeMouseY = 0;
dummy = {};
returnIDFloat = 0;
infiniteLoopPresent = false;

//stepping
autostep = 1;
autoplay = null;
autointerval = 300;

isViewingDecoratedCode = false;
decoratedCode = "";
undecoratedCode = "";

function process() {
    
    let tokens = [];
    let postfix = " Decoration";
    let markers = [];
    let funcCallMarkers = [];
    let code = editor.getValue();
    let myFunctions = [];
    
    let ast = acorn.parse(code, {
        ranges: true,
        locations: true,
        onToken: tokens
    });
    
    nodes = [];
    
    acorn.walk.ancestor(ast, acorn.walkall.makeVisitors(function(node, ancestors) {
        node.ancestors = [];
        for(let a of ancestors) {
            node.ancestors.push(a);
        }

        if(isGlobalOrSetup(node)) {
            // console.log(node);
            return;
        }

        //find the draw function and wrap its guts.
        if(node.type == _FunctionDeclaration 
            && node.id.name == "draw") {
            let blockNode = node.body;
            processWrapMainFunctionBody(blockNode);
        }

		//wrap function bodies that are not draw nor setup
		if(node.type == _FunctionDeclaration 
			|| node.type == _FunctionExpression) {
			myFunctions.push(node);
			if(node.id
				&& (node.id.name == "draw"
				|| node.id.name == "setup")) {
				return; //skip
			}
			let blockNode = node.body;
			processWrapNonMainFunctionBody(blockNode);
		}

        if(node.type == _IfStatement
            || node.type ==  _ForStatement
            || node.type ==  _WhileStatement) {
            processNodesWithTests(node);
        }
        if(node.type == _BreakStatement
            || node.type ==  _ReturnStatement) {
            processBeforeStatementNode(node);
        }
        if(node.type == _VariableDeclaration) {
            let parent = node.ancestors[node.ancestors.length-2];
            if(parent.type == _ForStatement
                || parent.type ==  _ForOfStatement) {
                //skip
            } else {
                processingVarDecl(node);
            }
        }
        if(node.type == _ExpressionStatement) {
            processExp(node);
        }
        if(node.type == _CallExpression) {
            processCallExp(node);
        }

        nodes.push(node);
    }), acorn.walkall.traversers);

    function insertAtPos(text, position) {
    	markers.push(new InsertionMarker(text, position));
    }
    
    function isGlobalOrSetup(node) {
        //loop through each ancestor
            //if it has no function parent, fail
            //if one is a function decl called "setup", fail
        let funcCounter = 0;
        for(let a of node.ancestors) {
            if(a.type == _FunctionDeclaration
                || a.type == _FunctionExpression) {
                if(a.id && a.id.name == "setup") {
                    return true;
                }
                funcCounter++;
            }
        }
        if(funcCounter==0) {
            return true;
        }

        return false;
    }
    
    function processExp(node) {
        processInsertAfterStatement(node, "EXPRESSION");
    }

    function processCallExp(node) {
        let lineNumber = node.loc.start.line;
        let postBreakPoint = "";
        let parent = node.ancestors[node.ancestors.length-2];
        let prePosition = node.range[0];
        //if this call is not its own expression, check to see if it is part of a variable declaration
        //if it is, process it.
        if(parent.type != _ExpressionStatement) {

	        try {
	        	let twoAncestorsAboveNode = node.ancestors.slice(node.ancestors.length-3, node.ancestors.length-1).map(i => i.type);
	        	window.koko = node.ancestors;
	        	console.log(node.ancestors);
	        	console.log(twoAncestorsAboveNode);
	        	if(twoAncestorsAboveNode.equals([_VariableDeclaration, _VariableDeclarator])) {
					prePosition = node.ancestors[node.ancestors.length-3].range[0]
	        	} else {
	        		return;//skip
	        	}
	        } catch (e) {
	        	console.error(e);
	        }
        }

        let pre = "BREAKPOINT("+lineNumber+");";
        let post = "BREAKPOINT("+lineNumber+");";

        funcCallMarkers.push({node:node, markerToAdd: new InsertionMarker(pre, prePosition)});

    }
    
    function processingVarDecl(node) {
        if(node.declarations
            && node.declarations[0] //to simplify, I assume there's only one declarator
            && node.declarations[0].init 
                && node.declarations[0].init.type == _FunctionExpression) {
                return; //skip
        }
        processInsertAfterStatement(node, "VAR");
    }

    function processInsertAfterStatement(node) {
        let lineNumber = node.loc.end.line;
        insertAtPos("BREAKPOINT("+lineNumber+");", node.range[1]);
    }

    function processBeforeStatementNode(node) {
        let lineNumber = node.loc.start.line;
        insertAtPos("BREAKPOINT("+lineNumber+");", node.range[0]);
    }

    function processNodesWithTests(node) {
        node = node.test;
        let lineNumber = node.loc.start.line;
        insertAtPos("BREAKPOINT("+lineNumber+")||", node.range[0]);

    }

    function processWrapNonMainFunctionBody(node) {
        let lineNumber = node.loc.start.line;
       	insertAtPos("BREAKPOINT("+lineNumber+");", node.range[0]+1);
       	//insertAtPos("END();", node.range[1]-1);
    }

    function processWrapMainFunctionBody(node) {
        //insertInsideTop
        let lineIndex;
        let columnIndex;
        let lineString;
        let decoratedLine;

        let topWrap = `
    GLOBAL_INDEX =-1;
    frameCount = fakeFrameCount;
    let tempX = mouseX;
    let tempY = mouseY;
    mouseX = fakeMouseX;
    mouseY = fakeMouseY;
    randomSeed(200);
    try {


`;

        let bottomWrap = `


        fakeFrameCount++;
        fakeMouseX = tempX;
        fakeMouseY = tempY;
        if(infiniteLoopPresent) {
            returnID = Math.trunc(returnIDFloat);
        } else {
            returnID = 0;
            returnIDFloat = 0;
        }
    }catch(e) {
        if(e.type && e.type == "return") {
            returnID = Math.trunc(returnIDFloat);
            console.log("super return", returnID);
        } else {
            throw e;
        }
    }
    mouseX = tempX;
    mouseY = tempY;

`;
        insertAtPos(topWrap, node.range[0]+1);
        insertAtPos(bottomWrap, node.range[1]-1);

    }

    for(let func of funcCallMarkers) {
    	let nameOfFunctionBeingCalled = null;
    	let node = func.node; //the call expression
    	if(node.callee.type == _Identifier) {
    		nameOfFunctionBeingCalled = node.callee.name;
    	} else {
    		continue;
    	}

    	let found = myFunctions.some(f => {
    		let thisFunctionsName = null;
			if(f.id) {
				thisFunctionsName = f.id.name;
			} else {//look at the parent variable declarator and get the var's name
		        let parent = f.ancestors[f.ancestors.length-2];
		        thisFunctionsName = parent.id.name;
			}
    		return thisFunctionsName == nameOfFunctionBeingCalled;
    	});

    	//"found" means that we found a call expression calling a function we defined.
    	if(found) {
    		markers.push(func.markerToAdd);
    	}
    }

    markers.sort(InsertionMarkerSorter);
	markers.reverse();
	for(let m of markers) {
		code = code.slice(0, m.position) + m.textToInsert + code.slice(m.position);
	}

    decoratedCode = code;

    return nodes;
}

function activateStepMode() {
    forfeitHighlightControl = true;
    stepping = true;
    debugmonokai();
}
function deactivateStepMode() {
    forfeitHighlightControl = false;
    stepping = false;
    returnID=0;
    returnIDFloat=0;
    if(autoplay) clearInterval(autoplay);
    monokai();
}
function toggleSteppingCodeView() {

}

function stepForward() {
    if(stepping == true) {
        returnIDFloat += 1;
    }
}

function stepBackward() {
    if(stepping == true) {
        returnIDFloat -= 1;
        if(returnIDFloat<0) returnIDFloat = 0;
    }
}

function startAutoStepping() {

}
function stopAutoStepping() {

}


$("#b0").click(function(){
    if(stepping == true) {
        returnIDFloat -= 1;
        if(returnIDFloat<0) returnIDFloat = 0;
    }
    forfeitHighlightControl = true;
    stepping = true;
    debugmonokai();
});

$("#b1").click(function(){
    if(stepping == true) {
        returnIDFloat += 1;
    }
    forfeitHighlightControl = true;
    stepping = true;
    debugmonokai();
});

$("#b2").click(function(){
    forfeitHighlightControl = false;
    stepping = false;
    returnID=0;
    returnIDFloat=0;
    if(autoplay) clearInterval(autoplay);
    monokai();
});

$("#b4").click(function(){
    returnID=0;
    forfeitHighlightControl = true;
    stepping = true;
    if(autoplay) clearInterval(autoplay);
    autoplay = setInterval(function() {
        returnIDFloat += autostep||1;
    },autointerval||300);
    debugmonokai();
});

$("#b5").click(function(){
    forfeitHighlightControl = false;
    stepping = false;
    if(autoplay) clearInterval(autoplay);
    monokai();
});

$("#b6").click(function(){
    editor.setValue(undecoratedCode);
});

$("#b7").click(function(){
    undecoratedCode = editor.getValue();
    process();
    editor.setValue(decoratedCode);
});
$("#b20").click(function(){
	activateStepMode();
});
$("#b21").click(function(){
	deactivateStepMode();
});
$("#b22").click(function(){
	stepForward();
});
$("#b23").click(function(){
	stepBackward();
});
$("#b24").click(function(){
	startAutoStepping();
});
$("#b25").click(function(){
	stopAutoStepping();
});
$("#b26").click(function(){
	toggleSteppingCodeView();
});

function highlightLine(lineNumber) {
    if(forfeitHighlightControl) {
        let l = lineNumber-1;
        editor.selection.setRange(new Range(l, 10000, l, 0));
    }
}

function BREAKPOINT(lineNumber) {
    if(stepping&&++GLOBAL_INDEX>=returnID) {highlightLine(lineNumber);throw {type:"return"};}
}

function InsertionMarker(textToInsert, position) {
	this.position = position;
    this.textToInsert = textToInsert;
}

function InsertionMarkerSorter(a, b) {
	if(a.position < b.position) {
        return -1;
	} else if(a.position > b.position) {
        return 1;
	} else {
		return 0;
	}
}

//____________________________________
//https://stackoverflow.com/a/14853974
//____________________________________
// Warn if overriding existing method
if(Array.prototype.equals)
    console.warn("Overriding existing Array.prototype.equals. Possible causes: New API defines the method, there's a framework conflict or you've got double inclusions in your code.");
// attach the .equals method to Array's prototype to call it on any array
Array.prototype.equals = function (array) {
    // if the other array is a falsy value, return
    if (!array)
        return false;

    // compare lengths - can save a lot of time 
    if (this.length != array.length)
        return false;

    for (var i = 0, l=this.length; i < l; i++) {
        // Check if we have nested arrays
        if (this[i] instanceof Array && array[i] instanceof Array) {
            // recurse into the nested arrays
            if (!this[i].equals(array[i]))
                return false;       
        }           
        else if (this[i] != array[i]) { 
            // Warning - two different object instances will never be equal: {x:20} != {x:20}
            return false;   
        }           
    }       
    return true;
}
// Hide method from for-in loops
Object.defineProperty(Array.prototype, "equals", {enumerable: false});
//______________________________________
//______________________________________
//______________________________________

const _ArrayExpression = "ArrayExpression"
const _AssignmentExpression = "AssignmentExpression"
const _BinaryExpression = "BinaryExpression"
const _BlockStatement = "BlockStatement"
const _BreakStatement = "BreakStatement"
const _CallExpression = "CallExpression"
const _CatchClause = "CatchClause"
const _ClassDeclaration = "ClassDeclaration"
const _ComprehensionExpression = "ComprehensionExpression"
const _ConditionalExpression = "ConditionalExpression"
const _ContinueStatement = "ContinueStatement"
const _DebuggerStatement = "DebuggerStatement"
const _DoWhileStatement = "DoWhileStatement"
const _EmptyStatement = "EmptyStatement"
const _ExportDeclaration = "ExportDeclaration"
const _ExportNamedDeclaration = "ExportNamedDeclaration"
const _Expression = "Expression"
const _ExpressionStatement = "ExpressionStatement"
const _ForInStatement = "ForInStatement"
const _ForInit = "ForInit"
const _ForStatement = "ForStatement"
const _ForOfStatement = "ForOfStatement" //added by yousif
const _ArrowFunctionExpression = "ArrowFunctionExpression"
const _Function = "Function"
const _FunctionDeclaration = "FunctionDeclaration"
const _FunctionExpression = "FunctionExpression"
const _Identifier = "Identifier"
const _IfStatement = "IfStatement"
const _ImportDeclaration = "ImportDeclaration"
const _ImportSpecifier = "ImportSpecifier"
const _ImportDefaultSpecifier = "ImportDefaultSpecifier"
const _LabeledStatement = "LabeledStatement"
const _Literal = "Literal"
const _LogicalExpression = "LogicalExpression"
const _MemberExpression = "MemberExpression"
const _MethodDefinition = "MethodDefinition"
const _NewExpression = "NewExpression"
const _ObjectExpression = "ObjectExpression"
const _ObjectPattern = "ObjectPattern"
const _Program = "Program"
const _ReturnStatement = "ReturnStatement"
const _ScopeBody = "ScopeBody"
const _SequenceExpression = "SequenceExpression"
const _Statement = "Statement"
const _SwitchCase = "SwitchCase"
const _SwitchStatement = "SwitchStatement"
const _TaggedTemplateExpression = "TaggedTemplateExpression"
const _ThisExpression = "ThisExpression"
const _ThrowStatement = "ThrowStatement"
const _TryStatement = "TryStatement"
const _UnaryExpression = "UnaryExpression"
const _UpdateExpression = "UpdateExpression"
const _VariableDeclaration = "VariableDeclaration"
const _VariableDeclarator = "VariableDeclarator"
const _WhileStatement = "WhileStatement"
const _WithStatement = "WithStatement"
const _Property = "Property"

        </script>
        <div class="modal fade" id="myModal" role="dialog" aria-labelledby="snippetsModalTitle" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header"> 
                        <h4 class="modal-title" id="snippetsModalTitle">Snippets</h4>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <span id="snippetLoading"></span>
                    </div>
                    <div class="modal-body">
                        <div style="max-height: 300px; overflow: auto;">
                            <table class="table table-hover">
                                <thead>
                                <tr>
                                <th>Snippet Number</th>
                                <th>Snippet Title</th>
                                </tr>
                                </thead>
                                <tbody id="snippetsTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <span id="loadingGif" style="display:none;margin-right:20px;"><img src="loading.gif"/></span>
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
